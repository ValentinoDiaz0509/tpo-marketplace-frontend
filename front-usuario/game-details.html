<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Detalle del Juego</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; padding: 20px; }
    #game-container { margin-bottom: 20px; }
    img { width: 250px; border-radius: 10px; }
    button {
      margin-right: 10px;
      padding: 10px 15px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover { background: #0056b3; }
    #msg { margin-top: 20px; color: green; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Detalle del juego</h1>
  <div id="game-container"></div>

  <button id="addToCart">üõí Agregar al carrito</button>
  <button id="addToWishlist">‚ù§Ô∏è Agregar a Wishlist</button>
  <div id="msg"></div>

  <script>
    const API_URL = "http://localhost:4002";
    const params = new URLSearchParams(window.location.search);
    const id = params.get("id");
    const token = localStorage.getItem("token");

    // detalles del juego
    async function loadGame() {
      try {
        const res = await fetch(`${API_URL}/games/${id}`);
        if (!res.ok) throw new Error("Error al cargar el juego");
        const game = await res.json();
        document.getElementById("game-container").innerHTML = `
          <h2>${game.title}</h2>
          <img src="${game.imageUrl}" alt="${game.title}"/>
          <p><b>Precio:</b> $${game.price}</p>
          <p><b>Descuento:</b> ${game.discount * 100}%</p>
          <p><b>Plataforma:</b> ${game.platform}</p>
          <p><b>Stock:</b> ${game.stock}</p>
        `;
      } catch (err) {
        document.getElementById("game-container").innerHTML = "<p>Error al cargar el juego.</p>";
      }
    }

    //  Agregar al carrito 
    document.getElementById("addToCart").addEventListener("click", () => {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      const exists = cart.some(item => item.id == id);
      if (!exists) {
        cart.push({ id, quantity: 1 });
        localStorage.setItem("cart", JSON.stringify(cart));
        document.getElementById("msg").textContent = "Agregado al carrito üõí";
      } else {
        document.getElementById("msg").textContent = "Ya est√° en el carrito ‚úÖ";
      }
    });

    // Agregar a Wishlist 
    document.getElementById("addToWishlist").addEventListener("click", async () => {
      if (!token) {
        alert("Debes iniciar sesi√≥n para usar la Wishlist");
        return;
      }
      try {
        const resUser = await fetch(`${API_URL}/api/v1/users/me`, {
          headers: { "Authorization": `Bearer ${token}` }
        });
        const user = await resUser.json();

        const wishlistId = user.wishlist?.id || 1; // fallback si a√∫n no est√° enlazada
        const res = await fetch(`${API_URL}/wishlist/${wishlistId}/add`, {
          method: "PUT",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
          },
          body: JSON.stringify({ gameId: id })
        });
        document.getElementById("msg").textContent =
          res.ok ? "Agregado a tu Wishlist ‚ù§Ô∏è" : "Error al agregar a Wishlist";
      } catch (err) {
        console.error(err);
        document.getElementById("msg").textContent = "Error al agregar a Wishlist";
      }
    });

    loadGame();
  </script>
</body>
</html>
